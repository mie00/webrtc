<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Styled Page</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md py-4 px-6 flex justify-between items-center">
        <h1 class="text-xl font-semibold text-gray-800">Video Call App</h1>
        <button id='hangup' class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">Hang Up</button>
    </header>

    <!-- Main Content - Video Call Area and Controls -->
    <main class="flex-1 flex">
        <!-- Video Call Area -->
        <div id="media" class="flex-1 relative bg-black">
            <!-- Placeholder for video streams -->
            <!-- You would typically use a library like Twilio Video SDK or similar to manage video streams -->
        </div>

        <!-- Controls Panel -->
        <div class="w-1/4 bg-gray-200 p-4 flex flex-col space-y-4">
            <!-- Participants -->
            <div class="flex items-center space-x-2">
                <div class="bg-gray-400 rounded-full h-4 w-4"></div> <!-- Participant indicator -->
                <p id="stat" class="text-sm font-medium text-gray-700"></p>
            </div>
            <!-- End Participants -->

			<div class="flex flex-col space-y-2">
				Stun server <input id="stun-servers" type="text" placeholder="Stun servers" class="flex-1 border border-gray-300 px-3 py-2 rounded-md" value="stun.l.google.com:19302">
			</div>
            <!-- On/Off Buttons -->
            <div class="flex flex-col space-y-2">
                <button id="toggle-video" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Toggle Video</button>
                <button id="toggle-audio" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Toggle Audio</button>
                <button id="toggle-screen" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Share Screen</button>
                <div class="flex items-center">
                    <input id="forward-host" type="text" placeholder="host to forward" class="flex-1 border border-gray-300 px-3 py-2 rounded-md" value="http://127.0.0.1:5000">
                    <button id="start-forward" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md ml-auto">Forward</button>
                </div>
            </div>
            <!-- End On/Off Buttons -->

            <!-- Chat Panel -->
            <div class="flex-1 flex flex-col border-t border-gray-300 pt-4">
                <!-- Messages Area -->
                <div id="output" class="flex-1 overflow-y-auto px-4">
                </div>

                <!-- Message Input and Upload Button -->
                <div class="flex items-center space-x-2 p-2">
                    <input id="chat" type="text" placeholder="Type your message..." class="flex-1 border border-gray-300 px-3 py-2 rounded-md">
                    <!-- <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Send</button> -->
                <div class="p-2">
                    <label for="file-upload" class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">ðŸ“Ž</label>
                    <input id="file-upload" type="file" class="hidden">
                </div>
                </div>
            </div>
            <!-- End Chat Panel -->
        </div>
        <!-- End Controls Panel -->
    </main>

    <!-- Overlay for Copying String -->
    <div id="copy-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-4 rounded-md shadow-md text-center">
			<div id="qrcode"></div>
            <p class="text-lg font-semibold mb-2">Copy this:</p>
            <textarea readonly id="copy-text" class="bg-gray-200 px-4 py-2 rounded-md break-all block"></textarea>
            <button id="copy-button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2">Copy</button>
            <textarea id="copy-text-2" class="bg-gray-200 px-4 py-2 rounded-md break-all block hidden"></textarea>
            <button id="copy-button-2" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md mt-2 hidden">Accept</button>
        </div>
    </div>
	<script src="chat.js"></script>
	<script src="file.js"></script>
	<script src="stream.js"></script>
	<script src="forward.js"></script>
	<script>
		const app = {};

		document.getElementById('hangup').addEventListener('click', () => {
			if (app.pc) {
				app.pc.close();
				app.pc = null;
			}
			windowLoader();
		})

		async function init() {
			const config = {
				iceServers: document.getElementById("stun-servers").value.split(',').filter(link => link).map(link => ({urls: "stun:" + link})),
			};

			const pc = new RTCPeerConnection(config);
			app.pc = pc;

			app.pc.oniceconnectionstatechange = e => log(app.pc.iceConnectionState);

			app.pc.onconnectionstatechange = ev => handleChange();
			app.pc.oniceconnectionstatechange = ev => handleChange();

			const nego_dc = pc.createDataChannel("nego", {
				negotiated: true,
				id: 0
			});
			app.nego_dc = nego_dc;
			nego_dc.onopen = () => {
				document.getElementById("copy-overlay").classList.add('hidden');
				history.pushState('', '', window.location.origin + window.location.pathname)
			};
			nego_dc.onclose = () => {
				windowLoader();
			}

			nego_dc.onmessage = async e => {
				const data = JSON.parse(e.data);
				pc.setRemoteDescription(data);
				if (data.type === "offer") {
					await pc.setLocalDescription();
					nego_dc.send(JSON.stringify(pc.localDescription));
				}
			};

			setupTrackHandler(app);
			if (true) {
				setupChatChannel(app);
				setupFileChannel(app);
				setupForwardChannel(app);
			}
		}

		const log = msg => output.innerHTML += `<br>${msg}`;

		async function getOffer(cb) {
			await init();
			await app.pc.setLocalDescription(await app.pc.createOffer());

			app.pc.onnegotiationneeded = async function() {
				const offer = await app.pc.createOffer()
				await app.pc.setLocalDescription(offer);
				app.nego_dc.send(JSON.stringify(offer));
			};
			app.pc.onicecandidate = async ({
				candidate
			}) => {
				console.log('Candidate found', candidate)
				await cb(app.pc.localDescription.sdp);
			};
		}

		async function getAnswer(offer, cb) {
			await init();
			await app.pc.setRemoteDescription({
				type: "offer",
				sdp: offer.trim() + '\n'
			});
			await app.pc.setLocalDescription(await app.pc.createAnswer());

			app.pc.onnegotiationneeded = async function() {
				const offer = await app.pc.createOffer()
				await app.pc.setLocalDescription(offer);
				app.nego_dc.send(JSON.stringify(offer));
			};
			app.pc.onicecandidate = async ({
				candidate
			}) => {
				console.log(candidate)
				await cb(app.pc.localDescription.sdp)
			};
		}

		function handleChange() {
			let stat = 'ConnectionState: <strong>' + app.pc?.connectionState + '</strong> IceConnectionState: <strong>' + app.pc?.iceConnectionState + '</strong>';
			document.getElementById('stat').innerHTML = stat;
			console.log('%c' + new Date().toISOString() + ': ConnectionState: %c' + app.pc?.connectionState + ' %cIceConnectionState: %c' + app.pc?.iceConnectionState,
				'color:yellow', 'color:orange', 'color:yellow', 'color:orange');
		}
		handleChange();


		const windowLoader = async () => {
			const urlParams = new URLSearchParams(window.location.search);
			window.removeEventListener("load", windowLoader);
			if (!urlParams.get('offer')) {
				const now = Date.now();
				await getOffer(async (sdp) => {
					if (Date.now() - now > 10 * 1000) { return }
					const link = document.getElementById('copy-text');
					document.getElementById('copy-overlay').classList.remove('hidden');
					const compressed = await compress(sdp, "gzip");
					urlParams.set('offer', compressed);
					document.getElementById("qrcode").innerHTML = '';
					new QRCode(document.getElementById("qrcode"), window.location.origin + window.location.pathname + '?' +  urlParams.toString());
					link.innerHTML = window.location.origin + window.location.pathname + '?' +  urlParams.toString();
					const btn = document.getElementById("copy-button");
					btn.innerHTML = "Copy";
					btn.addEventListener("click", async (ev) => {
						if (navigator.clipboard) {
							await navigator.clipboard.writeText(link.innerHTML);
							btn.innerHTML = "Copied successfully";
						} else {
							btn.innerHTML = "Error copying, please copy manually";
						}
					})
					const btn2 = document.getElementById("copy-button-2");
					const link2 = document.getElementById('copy-text-2');
					link2.value = '';
					btn2.classList.remove('hidden');
					link2.classList.remove('hidden');
					btn2.addEventListener("click", async (ev) => {
						let data = link2.value;
						const answer = await decompress(data.trim(), "gzip");
						app.pc.setRemoteDescription({
							type: "answer",
							sdp: answer.trim() + '\n'
						});
					})
					const bc = new BroadcastChannel("manual_rtc");
					app.bc = bc;
					bc.onmessage = async (event) => {
						let data = event.data;
						const answer = await decompress(data.trim(), "gzip");
						app.pc.setRemoteDescription({
							type: "answer",
							sdp: answer.trim() + '\n'
						});
					};
				})
			} else if (urlParams.get('answer')) {
				const bc = new BroadcastChannel("manual_rtc");
				await bc.postMessage(urlParams.get('answer'));
				bc.close();
				document.getElementById('copy-overlay').classList.remove('hidden');
				document.getElementById('copy-overlay').innerHTML = '<p class="bg-white p-4 rounded-md shadow-md text-center">call started on another tab, please close this one</p>';
			} else {
				const now = Date.now();
				const offer = await decompress(urlParams.get('offer'), "gzip");
				await getAnswer(offer, async (sdp) => {
					if (Date.now() - now > 10 * 1000) { return }
					console.log(sdp)
					const link = document.getElementById('copy-text');
					document.getElementById('copy-overlay').classList.remove('hidden');
					const compressed = await compress(sdp, "gzip");
					urlParams.set('answer', compressed);
					document.getElementById("qrcode").innerHTML = '';
					new QRCode(document.getElementById("qrcode"), window.location.origin + window.location.pathname + '?' +  urlParams.toString());
					link.innerHTML = compressed;
					const btn = document.getElementById("copy-button");
					btn.innerHTML = "Copy";
					btn.addEventListener("click", async (ev) => {
						if (navigator.clipboard) {
							await navigator.clipboard.writeText(link.innerHTML);
							btn.innerHTML = "Copied successfully";
						} else {
							btn.innerHTML = "Error copying, please copy manually";
						}
					})
				})
			}
		}
		window.addEventListener("load", windowLoader);


	</script>
	<script src="sdpcompress.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>

</html>
